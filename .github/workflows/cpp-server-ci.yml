name: C++ Server Build and Test

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'cpp_server/**'
      - 'data/**'
      - '.github/workflows/cpp-server-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp_server/**'
      - 'data/**'
      - '.github/workflows/cpp-server-ci.yml'
  workflow_dispatch:

# Limit GITHUB_TOKEN permissions to minimum required
permissions:
  contents: read

jobs:
  build-and-test-linux:
    name: Build and Test on Ubuntu
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Configure CMake
      working-directory: cpp_server
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DUSE_STEAM_SDK=OFF

    - name: Build server
      working-directory: cpp_server/build
      run: cmake --build . --config Release -j$(nproc)

    - name: Run tests
      working-directory: cpp_server/build
      run: ./bin/test_systems

    - name: Upload server artifact
      uses: actions/upload-artifact@v4
      with:
        name: eve-server-linux
        path: |
          cpp_server/build/bin/eve_dedicated_server
          cpp_server/build/bin/config/
        retention-days: 7

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Configure CMake
      working-directory: cpp_server
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON -DUSE_STEAM_SDK=OFF

    - name: Build server
      working-directory: cpp_server/build
      run: cmake --build . --config Release

    - name: Run tests
      working-directory: cpp_server/build
      run: |
        if (Test-Path "bin/Release/test_systems.exe") {
          ./bin/Release/test_systems.exe
        } elseif (Test-Path "bin/test_systems.exe") {
          ./bin/test_systems.exe
        } else {
          Write-Host "test_systems not found, listing bin directory:"
          Get-ChildItem -Recurse bin
        }

    - name: Upload server artifact
      uses: actions/upload-artifact@v4
      with:
        name: eve-server-windows
        path: |
          cpp_server/build/bin/Release/eve_dedicated_server.exe
          cpp_server/build/bin/config/
        retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-and-test-linux, build-windows]
    if: always()
    permissions:
      contents: read

    steps:
    - name: Check build results
      run: |
        echo "Server Build Summary:"
        echo "====================="
        echo "Linux:   ${{ needs.build-and-test-linux.result }}"
        echo "Windows: ${{ needs.build-windows.result }}"

        if [[ "${{ needs.build-and-test-linux.result }}" == "success" ]] && \
           [[ "${{ needs.build-windows.result }}" == "success" ]]; then
          echo "✓ All server builds and tests passed!"
          exit 0
        else
          echo "✗ Some builds or tests failed"
          exit 1
        fi
