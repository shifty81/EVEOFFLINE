name: C++ Client Build and Test

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'cpp_client/**'
      - '.github/workflows/cpp-client-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp_client/**'
      - '.github/workflows/cpp-client-ci.yml'
  workflow_dispatch:

# Limit GITHUB_TOKEN permissions to minimum required
permissions:
  contents: read

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # For uploading artifacts
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libglew-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxkbcommon-dev \
          wayland-protocols \
          libwayland-dev \
          libopenal-dev
    
    - name: Install system libraries
      run: |
        sudo apt-get install -y \
          libglfw3-dev \
          libglm-dev \
          nlohmann-json3-dev
    
    - name: Configure CMake
      working-directory: cpp_client
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_SYSTEM_LIBS=ON
    
    - name: Build
      working-directory: cpp_client/build
      run: make -j$(nproc)
    
    - name: List build artifacts
      working-directory: cpp_client/build
      run: |
        echo "Build directory contents:"
        find . -type f -executable -o -name "*.so" | head -20
    
    - name: Run network test
      working-directory: cpp_client/build/bin
      run: |
        if [ -f "test_network" ]; then
          ./test_network || echo "Network test failed (expected without server)"
        else
          echo "test_network not found, skipping"
        fi
    
    - name: Run entity sync test
      working-directory: cpp_client/build/bin
      run: |
        if [ -f "test_entity_sync" ]; then
          ./test_entity_sync || echo "Entity sync test completed"
        else
          echo "test_entity_sync not found, skipping"
        fi
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: eve-client-linux
        path: |
          cpp_client/build/bin/eve_client
          cpp_client/build/bin/shaders/
          cpp_client/build/bin/assets/
        retention-days: 7

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write  # For uploading artifacts
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Install vcpkg dependencies
      run: |
        vcpkg install glfw3:x64-windows glm:x64-windows glew:x64-windows nlohmann-json:x64-windows openal-soft:x64-windows
    
    - name: Configure CMake
      working-directory: cpp_client
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DUSE_SYSTEM_LIBS=ON
    
    - name: Build
      working-directory: cpp_client/build
      run: cmake --build . --config Release
    
    - name: List build artifacts
      working-directory: cpp_client/build
      run: dir /s /b bin
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: eve-client-windows
        path: |
          cpp_client/build/bin/Release/eve_client.exe
          cpp_client/build/bin/shaders/
          cpp_client/build/bin/assets/
        retention-days: 7

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    permissions:
      contents: read
      actions: write  # For uploading artifacts
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install cmake glfw glm glew nlohmann-json openal-soft
    
    - name: Configure CMake
      working-directory: cpp_client
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_SYSTEM_LIBS=ON
    
    - name: Build
      working-directory: cpp_client/build
      run: make -j$(sysctl -n hw.ncpu)
    
    - name: List build artifacts
      working-directory: cpp_client/build
      run: |
        echo "Build directory contents:"
        find . -type f -perm +111 | head -20
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: eve-client-macos
        path: |
          cpp_client/build/bin/eve_client
          cpp_client/build/bin/shaders/
          cpp_client/build/bin/assets/
        retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: always()
    permissions:
      contents: read
    
    steps:
    - name: Check build results
      run: |
        echo "Build Summary:"
        echo "=============="
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "Windows: ${{ needs.build-windows.result }}"
        echo "macOS: ${{ needs.build-macos.result }}"
        
        if [[ "${{ needs.build-linux.result }}" == "success" ]] && \
           [[ "${{ needs.build-windows.result }}" == "success" ]] && \
           [[ "${{ needs.build-macos.result }}" == "success" ]]; then
          echo "✓ All builds passed!"
          exit 0
        else
          echo "✗ Some builds failed"
          exit 1
        fi
